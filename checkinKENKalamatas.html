<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Soldier Tracker - Offline</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Using jsQR which works offline -->
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background: #2c3e50;
            color: white;
            padding: 20px;
            text-align: center;
            border-radius: 10px 10px 0 0;
            margin-bottom: 20px;
        }
        
        .tab-container {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .tabs {
            display: flex;
            background: #34495e;
        }
        
        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            color: white;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 16px;
        }
        
        .tab.active {
            background: #2c3e50;
            font-weight: bold;
        }
        
        .tab-content {
            display: none;
            padding: 20px;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .scanner-container {
            text-align: center;
            margin: 20px 0;
        }
        
        #video-container {
            width: 100%;
            max-width: 400px;
            margin: 0 auto;
            position: relative;
        }
        
        #video {
            width: 100%;
            height: 300px;
            border: 2px solid #ddd;
            border-radius: 10px;
            background: #000;
        }
        
        #canvas {
            display: none;
        }
        
        .scan-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 200px;
            height: 200px;
            border: 2px solid #00ff00;
            border-radius: 10px;
            pointer-events: none;
        }
        
        .soldier-info {
            background: #ecf0f1;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            display: none;
        }
        
        .soldier-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin: 10px 0;
        }
        
        .detail-item {
            padding: 8px;
            background: white;
            border-radius: 5px;
            border-left: 4px solid #3498db;
        }
        
        .status-badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            color: white;
            font-weight: bold;
            margin: 5px;
        }
        
        .status-in { background: #27ae60; }
        .status-out { background: #e74c3c; }
        
        .rank-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 15px;
            background: #8e44ad;
            color: white;
            font-size: 12px;
            font-weight: bold;
            margin-left: 5px;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
            margin: 15px 0;
        }
        
        .btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .btn-primary { background: #3498db; color: white; }
        .btn-success { background: #27ae60; color: white; }
        .btn-danger { background: #e74c3c; color: white; }
        .btn-warning { background: #f39c12; color: white; }
        
        .stats {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
            margin: 15px 0;
        }
        
        .stat-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border-left: 4px solid #3498db;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .stat-card.rank { border-left-color: #8e44ad; }
        .stat-card.in { border-left-color: #27ae60; }
        .stat-card.out { border-left-color: #e74c3c; }
        
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #2c3e50;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ecf0f1;
        }
        
        th {
            background: #34495e;
            color: white;
            font-weight: bold;
        }
        
        tr:hover {
            background: #f8f9fa;
        }
        
        .duration {
            font-family: monospace;
            font-weight: bold;
        }
        
        .alert {
            padding: 12px;
            border-radius: 6px;
            margin: 10px 0;
            text-align: center;
            font-weight: bold;
        }
        
        .alert-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .alert-error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .alert-warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        
        .camera-controls {
            margin: 15px 0;
        }
        
        .rank-filter {
            margin: 10px 0;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
        }
        
        .rank-legend {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 10px 0;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 12px;
        }
        
        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }
        
        @media (max-width: 600px) {
            .container {
                padding: 10px;
            }
            
            .tabs {
                flex-direction: column;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .stats {
                grid-template-columns: 1fr;
            }
            
            .soldier-details {
                grid-template-columns: 1fr;
            }
            
            #video {
                height: 250px;
            }
            
            .scan-overlay {
                width: 150px;
                height: 150px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ðŸ‡¬ðŸ‡· Soldier Tracker</h1>
            <p>Offline QR Code Check-in/out System</p>
        </header>
        
        <div class="tab-container">
            <div class="tabs">
                <button class="tab active" onclick="switchTab('scanner')">Scanner</button>
                <button class="tab" onclick="switchTab('dashboard')">Dashboard</button>
                <button class="tab" onclick="switchTab('reports')">Reports</button>
            </div>
            
            <!-- Scanner Tab -->
            <div id="scanner" class="tab-content active">
                <div class="scanner-container">
                    <h3>Scan Soldier QR Code</h3>
                    
                    <div class="camera-controls">
                        <button class="btn btn-primary" onclick="startCamera()" id="startBtn">Start Camera</button>
                        <button class="btn btn-danger" onclick="stopCamera()" id="stopBtn" style="display: none;">Stop Camera</button>
                    </div>
                    
                    <div id="video-container">
                        <video id="video" playsinline style="display: none;"></video>
                        <canvas id="canvas"></canvas>
                        <div class="scan-overlay"></div>
                    </div>
                    
                    <div id="cameraStatus" class="alert alert-warning" style="display: none;">
                        Camera is starting... Please allow camera permissions.
                    </div>
                </div>
                
                <div id="soldierInfo" class="soldier-info">
                    <h4>Soldier Information</h4>
                    <div class="soldier-details">
                        <div class="detail-item">
                            <strong>Full Name:</strong><br>
                            <span id="soldierName"></span>
                        </div>
                        <div class="detail-item">
                            <strong>Rank (TITLE):</strong><br>
                            <span id="soldierRank"></span>
                            <span class="rank-badge" id="rankBadge"></span>
                        </div>
                        <div class="detail-item">
                            <strong>Last Name:</strong><br>
                            <span id="soldierLastName"></span>
                        </div>
                        <div class="detail-item">
                            <strong>First Name:</strong><br>
                            <span id="soldierFirstName"></span>
                        </div>
                    </div>
                    
                    <div style="text-align: center; margin: 15px 0;">
                        <strong>Current Status:</strong> 
                        <span id="currentStatus"></span>
                    </div>
                    
                    <div class="action-buttons">
                        <button class="btn btn-success" onclick="checkIn()">Check IN</button>
                        <button class="btn btn-danger" onclick="checkOut()">Check OUT</button>
                        <button class="btn btn-primary" onclick="continueScanning()">Scan Another</button>
                    </div>
                </div>
                
                <div id="alert" class="alert" style="display: none;"></div>
                
                <div class="stats">
                    <div class="stat-card">
                        <div class="stat-number" id="checkedInCount">0</div>
                        <div>Currently Checked In</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="todayRecords">0</div>
                        <div>Today's Records</div>
                    </div>
                    <div class="stat-card rank">
                        <div class="stat-number" id="uniqueSoldiers">0</div>
                        <div>Unique Soldiers</div>
                    </div>
                </div>
            </div>
            
            <!-- Dashboard Tab -->
            <div id="dashboard" class="tab-content">
                <h3>Current Status</h3>
                <div class="action-buttons">
                    <button class="btn btn-warning" onclick="refreshDashboard()">Refresh</button>
                    <button class="btn btn-primary" onclick="exportTodayReport()">Export Today's Report</button>
                </div>
                
                <div class="stats">
                    <div class="stat-card in">
                        <div class="stat-number" id="dashboardCheckedIn">0</div>
                        <div>Checked In Now</div>
                    </div>
                    <div class="stat-card out">
                        <div class="stat-number" id="dashboardCheckedOut">0</div>
                        <div>Checked Out</div>
                    </div>
                    <div class="stat-card rank">
                        <div class="stat-number" id="dashboardTotal">0</div>
                        <div>Total Soldiers</div>
                    </div>
                </div>
                
                <div class="rank-filter">
                    <label><strong>Filter by Rank:</strong></label>
                    <select id="rankFilter" onchange="filterByRank()">
                        <option value="all">All Ranks</option>
                    </select>
                </div>
                
                <h4>Currently Checked In</h4>
                <div id="currentList"></div>
                
                <h4>Today's Activity</h4>
                <div id="todayActivity"></div>
            </div>
            
            <!-- Reports Tab -->
            <div id="reports" class="tab-content">
                <h3>Daily Reports</h3>
                <div class="action-buttons">
                    <input type="date" id="reportDate" value="<?php echo date('Y-m-d'); ?>">
                    <button class="btn btn-primary" onclick="generateDateReport()">Generate Report</button>
                    <button class="btn btn-warning" onclick="clearAllData()">Clear All Data</button>
                </div>
                
                <div id="reportResults"></div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentSoldier = null;
        let videoStream = null;
        let scanning = false;
        let canvasContext = null;
        
        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            updateStats();
            initializeCanvas();
            refreshDashboard();
        });
        
        // Tab switching
        function switchTab(tabName) {
            // Stop camera when leaving scanner tab
            if (tabName !== 'scanner') {
                stopCamera();
            }
            
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.getElementById(tabName).classList.add('active');
            document.querySelector(`.tab[onclick="switchTab('${tabName}')"]`).classList.add('active');
            
            if (tabName === 'dashboard') {
                refreshDashboard();
            }
        }
        
        // Camera functions
        function initializeCanvas() {
            const canvas = document.getElementById('canvas');
            canvasContext = canvas.getContext('2d');
        }
        
        async function startCamera() {
            try {
                showCameraStatus('Camera is starting... Please allow camera permissions.');
                
                const video = document.getElementById('video');
                video.style.display = 'block';
                
                // Get camera stream
                videoStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        facingMode: 'environment',
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    } 
                });
                
                video.srcObject = videoStream;
                
                // Wait for video to be ready
                video.onloadedmetadata = function() {
                    video.play();
                    showCameraStatus('Camera ready. Point at QR code to scan.');
                    document.getElementById('startBtn').style.display = 'none';
                    document.getElementById('stopBtn').style.display = 'inline-block';
                    startScanning();
                };
                
            } catch (error) {
                console.error('Camera error:', error);
                showCameraStatus('Camera access denied. Please allow camera permissions and try again.');
            }
        }
        
        function stopCamera() {
            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
                videoStream = null;
            }
            
            scanning = false;
            document.getElementById('video').style.display = 'none';
            document.getElementById('startBtn').style.display = 'inline-block';
            document.getElementById('stopBtn').style.display = 'none';
            hideCameraStatus();
        }
        
        function showCameraStatus(message) {
            const status = document.getElementById('cameraStatus');
            status.textContent = message;
            status.style.display = 'block';
            status.className = 'alert alert-warning';
        }
        
        function hideCameraStatus() {
            document.getElementById('cameraStatus').style.display = 'none';
        }
        
        // QR Scanning with jsQR (works offline)
        function startScanning() {
            scanning = true;
            scanQRCode();
        }
        
        function scanQRCode() {
            if (!scanning) return;
            
            const video = document.getElementById('video');
            const canvas = document.getElementById('canvas');
            
            if (video.readyState === video.HAVE_ENOUGH_DATA) {
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                
                // Draw video frame to canvas
                canvasContext.drawImage(video, 0, 0, canvas.width, canvas.height);
                
                // Get image data from canvas
                const imageData = canvasContext.getImageData(0, 0, canvas.width, canvas.height);
                
                // Try to decode QR code
                const code = jsQR(imageData.data, imageData.width, imageData.height, {
                    inversionAttempts: 'dontInvert',
                });
                
                if (code) {
                    console.log('QR Code detected:', code.data);
                    const soldier = parseVCard(code.data);
                    if (soldier) {
                        currentSoldier = soldier;
                        displaySoldierInfo(soldier);
                        stopCamera();
                    } else {
                        showAlert('Invalid QR code format. Please scan a valid soldier vCard.', 'error');
                    }
                }
            }
            
            // Continue scanning
            if (scanning) {
                requestAnimationFrame(scanQRCode);
            }
        }
        
        // Enhanced vCard parsing with better TITLE handling
        function parseVCard(vcardText) {
            try {
                console.log('Parsing vCard:', vcardText);
                
                const lines = vcardText.split('\n');
                const data = {};
                
                lines.forEach(line => {
                    const trimmedLine = line.trim();
                    
                    if (trimmedLine.startsWith('FN:')) {
                        data.fullName = trimmedLine.replace('FN:', '').trim();
                    } else if (trimmedLine.startsWith('N:')) {
                        const nameParts = trimmedLine.replace('N:', '').split(';');
                        data.lastName = nameParts[0]?.trim() || '';
                        data.firstName = nameParts[1]?.trim() || '';
                    } else if (trimmedLine.startsWith('TITLE:')) {
                        data.rank = trimmedLine.replace('TITLE:', '').trim();
                    } else if (trimmedLine.startsWith('UID:')) {
                        data.id = trimmedLine.replace('UID:', '').trim();
                    }
                });
                
                // Generate ID from name if no UID
                if (!data.id) {
                    data.id = data.fullName || (data.lastName + ' ' + data.firstName);
                }
                
                // Ensure fullName exists
                if (!data.fullName && data.firstName && data.lastName) {
                    data.fullName = data.lastName + ' ' + data.firstName;
                }
                
                // Ensure rank exists (default if missing)
                if (!data.rank) {
                    data.rank = 'Unknown Rank';
                }
                
                console.log('Parsed soldier data:', data);
                return data.id && data.fullName ? data : null;
                
            } catch (error) {
                console.error('Error parsing vCard:', error);
                return null;
            }
        }
        
        // Enhanced soldier information display
        function displaySoldierInfo(soldier) {
            document.getElementById('soldierName').textContent = soldier.fullName;
            document.getElementById('soldierRank').textContent = soldier.rank;
            document.getElementById('rankBadge').textContent = soldier.rank;
            document.getElementById('soldierLastName').textContent = soldier.lastName || 'N/A';
            document.getElementById('soldierFirstName').textContent = soldier.firstName || 'N/A';
            
            const status = getCurrentStatus(soldier.id);
            const statusElement = document.getElementById('currentStatus');
            statusElement.textContent = status;
            statusElement.className = `status-badge status-${status.toLowerCase()}`;
            
            document.getElementById('soldierInfo').style.display = 'block';
            showAlert(`Scanned: ${soldier.fullName} (${soldier.rank})`, 'success');
        }
        
        function continueScanning() {
            currentSoldier = null;
            document.getElementById('soldierInfo').style.display = 'none';
            document.getElementById('alert').style.display = 'none';
            startCamera();
        }
        
        // Enhanced check in/out functions with rank tracking
        function checkIn() {
            if (!currentSoldier) return;
            
            const record = {
                id: currentSoldier.id,
                name: currentSoldier.fullName,
                lastName: currentSoldier.lastName,
                firstName: currentSoldier.firstName,
                rank: currentSoldier.rank,
                action: 'IN',
                timestamp: new Date().toISOString(),
                date: new Date().toLocaleDateString('en-CA')
            };
            
            saveRecord(record);
            showAlert(`${currentSoldier.fullName} (${currentSoldier.rank}) checked IN successfully`, 'success');
            updateStats();
        }
        
        function checkOut() {
            if (!currentSoldier) return;
            
            const record = {
                id: currentSoldier.id,
                name: currentSoldier.fullName,
                lastName: currentSoldier.lastName,
                firstName: currentSoldier.firstName,
                rank: currentSoldier.rank,
                action: 'OUT',
                timestamp: new Date().toISOString(),
                date: new Date().toLocaleDateString('en-CA')
            };
            
            saveRecord(record);
            showAlert(`${currentSoldier.fullName} (${currentSoldier.rank}) checked OUT successfully`, 'success');
            updateStats();
        }
        
        // Enhanced data management with rank tracking
        function getRecords() {
            return JSON.parse(localStorage.getItem('soldierRecords') || '[]');
        }
        
        function saveRecord(record) {
            const records = getRecords();
            records.push(record);
            localStorage.setItem('soldierRecords', JSON.stringify(records));
        }
        
        function getCurrentStatus(soldierId) {
            const records = getRecords();
            const soldierRecords = records.filter(r => r.id === soldierId);
            return soldierRecords.length > 0 ? soldierRecords[soldierRecords.length - 1].action : 'OUT';
        }
        
        function updateStats() {
            const records = getRecords();
            const today = new Date().toLocaleDateString('en-CA');
            const todayRecords = records.filter(r => r.date === today);
            const currentlyIn = getCurrentlyCheckedIn();
            const uniqueSoldiers = getUniqueSoldiers();
            
            document.getElementById('checkedInCount').textContent = currentlyIn.length;
            document.getElementById('todayRecords').textContent = todayRecords.length;
            document.getElementById('uniqueSoldiers').textContent = uniqueSoldiers.length;
        }
        
        function getCurrentlyCheckedIn() {
            const records = getRecords();
            const soldiers = {};
            
            records.forEach(record => {
                soldiers[record.id] = record.action;
            });
            
            return Object.keys(soldiers).filter(id => soldiers[id] === 'IN');
        }
        
        function getUniqueSoldiers() {
            const records = getRecords();
            const soldiers = {};
            
            records.forEach(record => {
                soldiers[record.id] = record;
            });
            
            return Object.values(soldiers);
        }
        
        // Enhanced dashboard functions with rank filtering
        function refreshDashboard() {
            updateStats();
            updateDashboardStats();
            displayCurrentlyCheckedIn();
            displayTodayActivity();
            updateRankFilter();
        }
        
        function updateDashboardStats() {
            const records = getRecords();
            const soldiers = {};
            
            // Get latest status for each soldier
            records.forEach(record => {
                if (!soldiers[record.id] || new Date(record.timestamp) > new Date(soldiers[record.id].timestamp)) {
                    soldiers[record.id] = record;
                }
            });
            
            const checkedIn = Object.values(soldiers).filter(s => s.action === 'IN');
            const checkedOut = Object.values(soldiers).filter(s => s.action === 'OUT');
            
            document.getElementById('dashboardCheckedIn').textContent = checkedIn.length;
            document.getElementById('dashboardCheckedOut').textContent = checkedOut.length;
            document.getElementById('dashboardTotal').textContent = Object.keys(soldiers).length;
        }
        
        function updateRankFilter() {
            const records = getRecords();
            const ranks = new Set();
            
            records.forEach(record => {
                if (record.rank) {
                    ranks.add(record.rank);
                }
            });
            
            const filter = document.getElementById('rankFilter');
            filter.innerHTML = '<option value="all">All Ranks</option>';
            
            ranks.forEach(rank => {
                const option = document.createElement('option');
                option.value = rank;
                option.textContent = rank;
                filter.appendChild(option);
            });
        }
        
        function filterByRank() {
            const selectedRank = document.getElementById('rankFilter').value;
            displayCurrentlyCheckedIn(selectedRank);
            displayTodayActivity(selectedRank);
        }
        
        function displayCurrentlyCheckedIn(filterRank = 'all') {
            const records = getRecords();
            const soldiers = {};
            
            // Get latest record for each soldier
            records.forEach(record => {
                if (!soldiers[record.id] || new Date(record.timestamp) > new Date(soldiers[record.id].timestamp)) {
                    soldiers[record.id] = record;
                }
            });
            
            let checkedIn = Object.values(soldiers).filter(s => s.action === 'IN');
            
            // Apply rank filter
            if (filterRank !== 'all') {
                checkedIn = checkedIn.filter(s => s.rank === filterRank);
            }
            
            let html = '<table>';
            html += '<tr><th>Name</th><th>Rank</th><th>Check-in Time</th></tr>';
            
            if (checkedIn.length === 0) {
                html += '<tr><td colspan="3" style="text-align: center;">No soldiers currently checked in</td></tr>';
            } else {
                checkedIn.forEach(soldier => {
                    const time = new Date(soldier.timestamp).toLocaleTimeString();
                    html += `<tr>
                        <td>${soldier.name}</td>
                        <td><span class="rank-badge">${soldier.rank}</span></td>
                        <td>${time}</td>
                    </tr>`;
                });
            }
            
            html += '</table>';
            document.getElementById('currentList').innerHTML = html;
        }
        
        function displayTodayActivity(filterRank = 'all') {
            const records = getRecords();
            const today = new Date().toLocaleDateString('en-CA');
            let todayRecords = records.filter(r => r.date === today);
            
            // Apply rank filter
            if (filterRank !== 'all') {
                todayRecords = todayRecords.filter(r => r.rank === filterRank);
            }
            
            let html = '<table>';
            html += '<tr><th>Time</th><th>Name</th><th>Rank</th><th>Action</th></tr>';
            
            if (todayRecords.length === 0) {
                html += '<tr><td colspan="4" style="text-align: center;">No activity today</td></tr>';
            } else {
                todayRecords.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                
                todayRecords.forEach(record => {
                    const time = new Date(record.timestamp).toLocaleTimeString();
                    const statusClass = record.action === 'IN' ? 'status-in' : 'status-out';
                    html += `<tr>
                        <td>${time}</td>
                        <td>${record.name}</td>
                        <td><span class="rank-badge">${record.rank}</span></td>
                        <td><span class="status-badge ${statusClass}">${record.action}</span></td>
                    </tr>`;
                });
            }
            
            html += '</table>';
            document.getElementById('todayActivity').innerHTML = html;
        }
        
        // Enhanced report generation with rank information
        function generateDateReport() {
            const date = document.getElementById('reportDate').value;
            const records = getRecords();
            const dateRecords = records.filter(r => r.date === date);
            
            let html = `<h4>Report for ${date}</h4>`;
            
            if (dateRecords.length === 0) {
                html += '<p>No records found for this date.</p>';
            } else {
                const soldierSessions = calculateSessions(dateRecords);
                
                html += `<button class="btn btn-success" onclick="exportDateReport('${date}')">Export to Excel</button>`;
                html += '<table>';
                html += '<tr><th>Name</th><th>Rank</th><th>Total Hours</th><th>Check-ins</th><th>Avg. Session</th></tr>';
                
                Object.values(soldierSessions).forEach(soldier => {
                    const avgSession = soldier.sessions > 0 ? (soldier.totalHours / soldier.sessions).toFixed(2) : '0';
                    html += `<tr>
                        <td>${soldier.name}</td>
                        <td><span class="rank-badge">${soldier.rank}</span></td>
                        <td class="duration">${formatDuration(soldier.totalHours)}</td>
                        <td>${soldier.sessions}</td>
                        <td>${avgSession}h</td>
                    </tr>`;
                });
                
                html += '</table>';
            }
            
            document.getElementById('reportResults').innerHTML = html;
        }
        
        function calculateSessions(records) {
            const soldiers = {};
            const sortedRecords = records.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
            
            sortedRecords.forEach(record => {
                if (!soldiers[record.id]) {
                    soldiers[record.id] = {
                        name: record.name,
                        rank: record.rank,
                        sessions: 0,
                        totalHours: 0,
                        lastCheckIn: null
                    };
                }
                
                if (record.action === 'IN') {
                    soldiers[record.id].lastCheckIn = new Date(record.timestamp);
                } else if (record.action === 'OUT' && soldiers[record.id].lastCheckIn) {
                    const checkOutTime = new Date(record.timestamp);
                    const duration = (checkOutTime - soldiers[record.id].lastCheckIn) / (1000 * 60 * 60);
                    soldiers[record.id].totalHours += duration;
                    soldiers[record.id].sessions++;
                    soldiers[record.id].lastCheckIn = null;
                }
            });
            
            Object.values(soldiers).forEach(soldier => {
                if (soldier.lastCheckIn) {
                    const currentDuration = (new Date() - soldier.lastCheckIn) / (1000 * 60 * 60);
                    soldier.totalHours += currentDuration;
                    soldier.sessions++;
                }
            });
            
            return soldiers;
        }
        
        function formatDuration(hours) {
            const wholeHours = Math.floor(hours);
            const minutes = Math.round((hours - wholeHours) * 60);
            return `${wholeHours}h ${minutes}m`;
        }
        
        function exportTodayReport() {
            const today = new Date().toLocaleDateString('en-CA');
            exportDateReport(today);
        }
        
        function exportDateReport(date) {
            const records = getRecords();
            const dateRecords = records.filter(r => r.date === date);
            const soldierSessions = calculateSessions(dateRecords);
            
            const excelData = [
                ['Soldier Report', date],
                ['Name', 'Rank', 'Total Hours', 'Formatted Hours', 'Sessions', 'Average Session Hours']
            ];
            
            Object.values(soldierSessions).forEach(soldier => {
                const avgSession = soldier.sessions > 0 ? (soldier.totalHours / soldier.sessions).toFixed(2) : '0';
                excelData.push([
                    soldier.name,
                    soldier.rank,
                    soldier.totalHours.toFixed(2),
                    formatDuration(soldier.totalHours),
                    soldier.sessions,
                    avgSession
                ]);
            });
            
            const ws = XLSX.utils.aoa_to_sheet(excelData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Soldier Report');
            XLSX.writeFile(wb, `soldier-report-${date}.xlsx`);
        }
        
        function clearAllData() {
            if (confirm('Are you sure you want to clear ALL data? This cannot be undone.')) {
                localStorage.removeItem('soldierRecords');
                showAlert('All data cleared successfully', 'success');
                refreshDashboard();
                updateStats();
            }
        }
        
        function showAlert(message, type) {
            const alert = document.getElementById('alert');
            alert.textContent = message;
            alert.className = `alert alert-${type}`;
            alert.style.display = 'block';
            
            setTimeout(() => {
                alert.style.display = 'none';
            }, 5000);
        }
    </script>
</body>
</html>